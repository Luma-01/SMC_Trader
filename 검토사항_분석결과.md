# ê²€í† ì‚¬í•­ ë¶„ì„ ê²°ê³¼ ğŸ“‹

## 1. 1ì°¨ ìµì ˆ(TP)ì„ ë°˜ëŒ€ OBë¡œ ì§€ì •í•˜ëŠ” ë¡œì§ âœ…

### êµ¬í˜„ ìƒíƒœ: **ì™„ë²½íˆ êµ¬í˜„ë¨**

**íŒŒì¼**: `main.py` (Line 297-318)

```python
# â”€â”€ 4) HTF ë°˜ëŒ€ OB extremeì— TP ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
tp_dec = None
htf_ob = detect_ob(htf)      # HTF DataFrameì—ì„œ OB ê°ì§€
# directionì— ë”°ë¼ opposite OB
if direction == "long":
    # ê°€ì¥ ê°€ê¹Œìš´ ìœ„ìª½ bearish OBì˜ low
    candidates = [Decimal(str(z["low"])) for z in htf_ob if z["type"] == "bearish" and Decimal(str(z["low"])) > entry_dec]
    if candidates:
        tp_dec = min(candidates)
else:
    # ê°€ì¥ ê°€ê¹Œìš´ ì•„ë˜ bullish OBì˜ high
    candidates = [Decimal(str(z["high"])) for z in htf_ob if z["type"] == "bullish" and Decimal(str(z["high"])) < entry_dec]
    if candidates:
        tp_dec = max(candidates)

# fallback: ê¸°ì¡´ RR TP
if tp_dec is None:
    rr_dec = Decimal(str(RR))
    if direction == "long":
        tp_dec = (entry_dec + (entry_dec - sl_dec) * rr_dec).quantize(tick_size)
    else:
        tp_dec = (entry_dec - (sl_dec - entry_dec) * rr_dec).quantize(tick_size)
```

### ë™ì‘ ì›ë¦¬:
1. **Long í¬ì§€ì…˜**: ì§„ì…ê°€ë³´ë‹¤ ìœ„ìª½ì˜ ê°€ì¥ ê°€ê¹Œìš´ bearish OBì˜ lowë¥¼ TPë¡œ ì„¤ì •
2. **Short í¬ì§€ì…˜**: ì§„ì…ê°€ë³´ë‹¤ ì•„ë˜ìª½ì˜ ê°€ì¥ ê°€ê¹Œìš´ bullish OBì˜ highë¥¼ TPë¡œ ì„¤ì •
3. **Fallback**: ë°˜ëŒ€ OBê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ RR(1.5) ê¸°ë°˜ TP ì‚¬ìš©

---

## 2. 1ì°¨ ìµì ˆ í›„ SLì„ ì§„ì…ê°€ë¡œ ì¡°ì • (ë°˜ìµë°˜ë³¸) âœ…

### êµ¬í˜„ ìƒíƒœ: **ì™„ë²½íˆ êµ¬í˜„ë¨**

**íŒŒì¼**: `core/position.py` (Line 254-296)

```python
# â¶ 1ì°¨ TP(ì ˆë°˜ ìµì ˆ) ë‹¬ì„± ì—¬ë¶€ **ë¨¼ì €** í™•ì¸
if not half_exit:
    if direction == "long" and current_price >= pos["tp"]:
        print(f"[PARTIAL TP] {symbol} LONG ì ˆë°˜ ìµì ˆ @ {current_price:.2f}")
        pos["half_exit"] = True

        # â”€â”€ NEW â”€â”€ â‘  ìµì ˆ ì§í›„ SL â†’ ë³¸ì ˆ(Entry)
        new_sl = entry                         # breakeven
        # tickSize ë¼ìš´ë“œ & ì§„ì…ê°€ì™€ â‰¥1 tick ì°¨ì´ í™•ë³´
        from exchange.router import get_tick_size as _tick
        tick = float(_tick(symbol) or 0)
        if direction == "long":
            new_sl = max(new_sl, sl + tick)    # ìµœì†Œ 1 tick â†‘
        else:  # short
            new_sl = min(new_sl, sl - tick)    # ìµœì†Œ 1 tick â†“

        if self.should_update_sl(symbol, new_sl):
            sl_res = update_stop_loss(symbol, direction, new_sl)
            if sl_res is not False:
                pos["sl"] = new_sl
                print(f"[SL->BE] {symbol} SL ë³¸ì ˆë¡œ ì´ë™ ì™„ë£Œ @ {new_sl:.4f}")
```

### ë™ì‘ ì›ë¦¬:
1. **1ì°¨ ìµì ˆ í™•ì¸**: í˜„ì¬ê°€ê°€ TPì— ë„ë‹¬í•˜ë©´ `half_exit = True` ì„¤ì •
2. **SL ì§„ì…ê°€ ì¡°ì •**: `new_sl = entry` (breakeven)
3. **Tick ì•ˆì „ ê±°ë¦¬**: ìµœì†Œ 1 tick ì°¨ì´ í™•ë³´
4. **ìë™ SL ì—…ë°ì´íŠ¸**: ê±°ë˜ì†Œì— ìƒˆë¡œìš´ SL ì£¼ë¬¸ ì „ì†¡

---

## 3. íŠ¸ë ˆì¼ë§ SLê³¼ ìŠ¤ìœ™ ì €ì  í™œìš© ğŸ”„

### êµ¬í˜„ ìƒíƒœ: **ë¶€ë¶„ì ìœ¼ë¡œ êµ¬í˜„ë¨ (ê°œì„  í•„ìš”)**

#### 3.1 íŠ¸ë ˆì¼ë§ SL í™œì„±í™” ì¡°ê±´ âœ…

**íŒŒì¼**: `core/position.py` (Line 561-564)

```python
# â‘  1ì°¨ ìµì ˆ(half_exit) ì „ì´ë©´ íŠ¸ë ˆì¼ë§ SL ë¹„í™œì„±
if not pos.get("half_exit"):
    return
# â‘¡ half_exit í›„ë¼ë„ *ì§„ì… 30 ì´ˆ ì´ë‚´* ëŠ” ë¬´ì‹œ (ê¸‰ê²©í•œ ë…¸ì´ì¦ˆ ë°©ì–´)
if time.time() - pos.get("_created", 0) < 30:
    return
```

#### 3.2 ìŠ¤ìœ™ ì €ì  ê°ì§€ ë¡œì§ âœ…

**íŒŒì¼**: `core/protective.py` (Line 6-40)

```python
def _is_swing_low(series, idx: int, span: int) -> bool:
    """idx ìº”ë“¤ì´ ì¢Œìš° span ê°œë³´ë‹¤ ëª¨ë‘ ë‚®ìœ¼ë©´ True"""
    low = series[idx]
    return low == min(series[idx - span: idx + span + 1])

def get_protective_level(df: pd.DataFrame,
                         direction: str,
                         lookback: int = 30,
                         span: int = 2) -> Optional[Dict]:
    """
    ìµœê·¼ LTF ìŠ¤ìœ™ ë¡œìš°(ë¡±) / ìŠ¤ìœ™ í•˜ì´(ìˆ) ë¥¼ ë³´í˜¸ì„ ìœ¼ë¡œ ë°˜í™˜
    â€¢ lookback êµ¬ê°„ ì•ˆì—ì„œ ê°€ì¥ ë§ˆì§€ë§‰ ìŠ¤ìœ™ í¬ì¸íŠ¸ë¥¼ ì‚¬ìš©
    """
    rng = range(len(df) - span - 1, max(len(df) - lookback - span, span) - 1, -1)
    for i in rng:
        if direction == "long" and _is_swing_low(lows, i, span):
            return {"protective_level": lows[i], "swing_time": df['time'][i]}
        if direction == "short" and _is_swing_high(highs, i, span):
            return {"protective_level": highs[i], "swing_time": df['time'][i]}
```

#### 3.3 íŠ¸ë ˆì¼ë§ SL ë¡œì§ âš ï¸

**íŒŒì¼**: `core/position.py` (Line 586-591)

```python
if direction == "long":
    new_sl = current_price * (1 - threshold_pct)  # í˜„ì¬ê°€ ê¸°ì¤€ íŠ¸ë ˆì¼ë§
    if (
        (new_sl - current_sl) > tick * 2                    # ìµœì†Œ 2 tick ìœ„
        and self.should_update_sl(symbol, new_sl)
        and (entry := pos["entry"])
        and abs(entry - new_sl) / entry >= min_rr
        and (protective is None or new_sl > protective)     # ë³´í˜¸ì„  ê³ ë ¤
    ):
```

### ë¬¸ì œì  ë¶„ì„ ğŸš¨

#### ë¬¸ì œ 1: íŠ¸ë ˆì¼ë§ SLì´ ìŠ¤ìœ™ ì €ì ì„ ì§ì ‘ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
```python
# í˜„ì¬ ë¡œì§: í˜„ì¬ê°€ ê¸°ì¤€ íŠ¸ë ˆì¼ë§ (0.8% í•˜ë½)
new_sl = current_price * (1 - threshold_pct)

# í•„ìš”í•œ ë¡œì§: ìŠ¤ìœ™ ì €ì  ê¸°ì¤€ íŠ¸ë ˆì¼ë§
new_sl = max(swing_low, current_price * (1 - threshold_pct))
```

#### ë¬¸ì œ 2: Protective Levelì´ ì œí•œì ìœ¼ë¡œë§Œ í™œìš©
- ë³´í˜¸ì„ ì€ MSS ê¸°ë°˜ìœ¼ë¡œë§Œ ê³„ì‚°ë¨
- ì‹¤ì‹œê°„ ìŠ¤ìœ™ ì €ì  ì—…ë°ì´íŠ¸ê°€ ë¶ˆì¶©ë¶„
- ë‹¨ìˆœíˆ "protectiveë³´ë‹¤ ìœ„í—˜í•˜ì§€ ì•Šê²Œ" ì¡°ê±´ìœ¼ë¡œë§Œ ì‚¬ìš©

#### ë¬¸ì œ 3: ìŠ¤ìœ™ ì €ì  ê°±ì‹  ë¹ˆë„ ë¶€ì¡±
- ë³´í˜¸ì„  ê°±ì‹ ì´ MSS íŠ¸ë¦¬ê±° ì‹œì—ë§Œ ë°œìƒ
- ì‹¤ì‹œê°„ ìŠ¤ìœ™ ì €ì  ëª¨ë‹ˆí„°ë§ ì—†ìŒ

---

## 4. ê¶Œì¥ ê°œì„ ì‚¬í•­ ğŸ”§

### 4.1 íŠ¸ë ˆì¼ë§ SL ê°œì„  (ê¸´ê¸‰)

```python
def try_update_trailing_sl(self, symbol: str, current_price: float):
    # ... ê¸°ì¡´ ë¡œì§ ...
    
    # ì‹¤ì‹œê°„ ìŠ¤ìœ™ ì €ì  ê³„ì‚°
    ltf_df = get_ltf_data(symbol)  # LTF ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    swing_data = get_protective_level(ltf_df, direction, lookback=20, span=2)
    swing_low = swing_data["protective_level"] if swing_data else None
    
    if direction == "long":
        # ìŠ¤ìœ™ ì €ì ê³¼ íŠ¸ë ˆì¼ë§ ì¤‘ ë” ë³´ìˆ˜ì ì¸ ê°’ ì„ íƒ
        trailing_sl = current_price * (1 - threshold_pct)
        if swing_low and swing_low > trailing_sl:
            new_sl = swing_low
        else:
            new_sl = trailing_sl
```

### 4.2 ìŠ¤ìœ™ ì €ì  ì‹¤ì‹œê°„ ê°±ì‹ 

```python
def update_swing_protective(self, symbol: str, ltf_df: pd.DataFrame):
    """ì‹¤ì‹œê°„ ìŠ¤ìœ™ ì €ì  ê°±ì‹ """
    pos = self.positions[symbol]
    direction = pos['direction']
    
    # ìµœê·¼ ìŠ¤ìœ™ ì €ì  ê³„ì‚°
    swing_data = get_protective_level(ltf_df, direction, lookback=30, span=2)
    if swing_data:
        new_swing = swing_data["protective_level"]
        current_swing = pos.get("swing_protective")
        
        # ë” ë³´ìˆ˜ì ì¸ ìŠ¤ìœ™ ì €ì ìœ¼ë¡œ ê°±ì‹ 
        if should_update_swing(direction, current_swing, new_swing):
            pos["swing_protective"] = new_swing
```

### 4.3 í•˜ì´ë¸Œë¦¬ë“œ íŠ¸ë ˆì¼ë§ ì‹œìŠ¤í…œ

```python
def calculate_hybrid_trailing_sl(self, symbol: str, current_price: float):
    """ìŠ¤ìœ™ ì €ì  + í¼ì„¼íŠ¸ íŠ¸ë ˆì¼ë§ í•˜ì´ë¸Œë¦¬ë“œ ì‹œìŠ¤í…œ"""
    pos = self.positions[symbol]
    direction = pos['direction']
    
    # 1. ê¸°ë³¸ í¼ì„¼íŠ¸ íŠ¸ë ˆì¼ë§
    percent_trailing = current_price * (1 - threshold_pct)
    
    # 2. ìŠ¤ìœ™ ì €ì  ê¸°ë°˜ íŠ¸ë ˆì¼ë§
    swing_trailing = pos.get("swing_protective")
    
    # 3. í•˜ì´ë¸Œë¦¬ë“œ ì„ íƒ
    if direction == "long":
        return max(percent_trailing, swing_trailing or 0)
    else:
        return min(percent_trailing, swing_trailing or float('inf'))
```

---

## 5. ê²°ë¡  ë° ìš°ì„ ìˆœìœ„ ğŸ“Š

### 5.1 í˜„ì¬ ìƒíƒœ í‰ê°€

| í•­ëª© | ìƒíƒœ | ì™„ì„±ë„ | ë¹„ê³  |
|------|------|--------|------|
| 1ì°¨ TP (ë°˜ëŒ€ OB) | âœ… ì™„ë£Œ | 100% | ì™„ë²½ êµ¬í˜„ë¨ |
| ë°˜ìµë°˜ë³¸ (SL â†’ ì§„ì…ê°€) | âœ… ì™„ë£Œ | 100% | ì™„ë²½ êµ¬í˜„ë¨ |
| íŠ¸ë ˆì¼ë§ SL | âš ï¸ ë¶€ë¶„ ì™„ë£Œ | 70% | ê°œì„  í•„ìš” |
| ìŠ¤ìœ™ ì €ì  í™œìš© | âš ï¸ ë¶€ë¶„ ì™„ë£Œ | 60% | ê°œì„  í•„ìš” |

### 5.2 ê°œì„  ìš°ì„ ìˆœìœ„

#### ğŸš¨ ê¸´ê¸‰ (1ì£¼ì¼ ì´ë‚´)
1. **íŠ¸ë ˆì¼ë§ SL ìŠ¤ìœ™ ì €ì  í†µí•©**: í˜„ì¬ê°€ ê¸°ì¤€ + ìŠ¤ìœ™ ì €ì  í•˜ì´ë¸Œë¦¬ë“œ
2. **ì‹¤ì‹œê°„ ìŠ¤ìœ™ ì €ì  ê°±ì‹ **: MSS ì™¸ì—ë„ ì§€ì†ì ì¸ ìŠ¤ìœ™ ì €ì  ëª¨ë‹ˆí„°ë§

#### ğŸ“‹ ì¤‘ê¸° (1ê°œì›” ì´ë‚´)
1. **ìŠ¤ìœ™ ì €ì  ì•Œê³ ë¦¬ì¦˜ ê°œì„ **: span=2 â†’ ë™ì  span ì¡°ì •
2. **íŠ¸ë ˆì¼ë§ ë¯¼ê°ë„ ì¡°ì •**: ì‹œì¥ ë³€ë™ì„±ì— ë”°ë¥¸ ë™ì  threshold

#### ğŸ¯ ì¥ê¸° (3ê°œì›” ì´ë‚´)
1. **ML ê¸°ë°˜ ìŠ¤ìœ™ ê°ì§€**: ì „í†µì  ìŠ¤ìœ™ ê°ì§€ + ë¨¸ì‹ ëŸ¬ë‹ ë³´ì™„
2. **ë°±í…ŒìŠ¤íŒ… ìµœì í™”**: íŠ¸ë ˆì¼ë§ SL íŒŒë¼ë¯¸í„° ìµœì í™”

### 5.3 ì „ì²´ í‰ê°€

**ê°•ì ** ğŸ’ª:
- 1ì°¨ TPì™€ ë°˜ìµë°˜ë³¸ ë¡œì§ì´ ì™„ë²½íˆ êµ¬í˜„ë¨
- ê¸°ë³¸ì ì¸ íŠ¸ë ˆì¼ë§ SL í”„ë ˆì„ì›Œí¬ ì¡´ì¬
- ìŠ¤ìœ™ ì €ì  ê°ì§€ ì•Œê³ ë¦¬ì¦˜ êµ¬í˜„ë¨

**ì•½ì ** âš ï¸:
- íŠ¸ë ˆì¼ë§ SLì´ ìŠ¤ìœ™ ì €ì ì„ ì§ì ‘ í™œìš©í•˜ì§€ ì•ŠìŒ
- ì‹¤ì‹œê°„ ìŠ¤ìœ™ ì €ì  ê°±ì‹  ë¶€ì¡±
- ë³´í˜¸ì„  í™œìš©ì´ ì œí•œì 

**ì´í‰**: ê¸°ë³¸ ê³¨ê²©ì€ ê²¬ê³ í•˜ë‚˜, íŠ¸ë ˆì¼ë§ SLê³¼ ìŠ¤ìœ™ ì €ì  í†µí•©ì´ í•µì‹¬ ê°œì„  ê³¼ì œ